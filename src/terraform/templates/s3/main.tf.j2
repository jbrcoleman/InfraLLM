# S3 Bucket: {{ resource_name }}
# Environment: {{ environment }}
# Generated by InfraLLM on {{ generated_at }}

resource "aws_s3_bucket" "{{ tf_resource_name }}" {
  bucket = "{{ resource_name }}"

  tags = {
{%- for key, value in tags.items() %}
    {{ key }} = "{{ value }}"
{%- endfor %}
  }
}

# Bucket versioning configuration
resource "aws_s3_bucket_versioning" "{{ tf_resource_name }}" {
  bucket = aws_s3_bucket.{{ tf_resource_name }}.id

  versioning_configuration {
    status = "{{ 'Enabled' if parameters.versioning else 'Suspended' }}"
  }
}

# Server-side encryption configuration
resource "aws_s3_bucket_server_side_encryption_configuration" "{{ tf_resource_name }}" {
  bucket = aws_s3_bucket.{{ tf_resource_name }}.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = "{{ parameters.encryption }}"
    }
  }
}

# Public access block configuration
resource "aws_s3_bucket_public_access_block" "{{ tf_resource_name }}" {
  bucket = aws_s3_bucket.{{ tf_resource_name }}.id

  block_public_acls       = {{ parameters.public_access_block | terraform_bool }}
  block_public_policy     = {{ parameters.public_access_block | terraform_bool }}
  ignore_public_acls      = {{ parameters.public_access_block | terraform_bool }}
  restrict_public_buckets = {{ parameters.public_access_block | terraform_bool }}
}
{%- if parameters.lifecycle_rules %}

# Lifecycle configuration
resource "aws_s3_bucket_lifecycle_configuration" "{{ tf_resource_name }}" {
  bucket = aws_s3_bucket.{{ tf_resource_name }}.id

{%- for rule in parameters.lifecycle_rules %}
  rule {
    id     = "{{ rule.id }}"
    status = "{{ 'Enabled' if rule.enabled else 'Disabled' }}"

{%- if rule.expiration_days %}
    expiration {
      days = {{ rule.expiration_days }}
    }
{%- endif %}
{%- if rule.transition_days and rule.storage_class %}

    transition {
      days          = {{ rule.transition_days }}
      storage_class = "{{ rule.storage_class }}"
    }
{%- endif %}
  }
{%- endfor %}
}
{%- endif %}
