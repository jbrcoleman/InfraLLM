# EKS Cluster: {{ resource_name }}
# Environment: {{ environment }}
# Generated by InfraLLM on {{ generated_at }}

# IAM Role for EKS Cluster
resource "aws_iam_role" "{{ tf_resource_name }}_cluster" {
  name = "{{ resource_name }}-cluster-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Action = "sts:AssumeRole"
      Effect = "Allow"
      Principal = {
        Service = "eks.amazonaws.com"
      }
    }]
  })

  tags = {
{%- for key, value in tags.items() %}
    {{ key }} = "{{ value }}"
{%- endfor %}
  }
}

resource "aws_iam_role_policy_attachment" "{{ tf_resource_name }}_cluster_policy" {
  policy_arn = "arn:aws:iam::aws:policy/AmazonEKSClusterPolicy"
  role       = aws_iam_role.{{ tf_resource_name }}_cluster.name
}

# EKS Cluster
resource "aws_eks_cluster" "{{ tf_resource_name }}" {
  name     = "{{ resource_name }}"
  role_arn = aws_iam_role.{{ tf_resource_name }}_cluster.arn
  version  = "{{ parameters.kubernetes_version }}"

  vpc_config {
    subnet_ids              = var.subnet_ids
    endpoint_private_access = {{ parameters.private_endpoint | terraform_bool }}
    endpoint_public_access  = {{ parameters.get('public_endpoint', false) | terraform_bool }}
  }

  tags = {
{%- for key, value in tags.items() %}
    {{ key }} = "{{ value }}"
{%- endfor %}
  }

  depends_on = [
    aws_iam_role_policy_attachment.{{ tf_resource_name }}_cluster_policy
  ]
}
{%- for node_group in parameters.node_groups %}

# IAM Role for Node Group: {{ node_group.name }}
resource "aws_iam_role" "{{ tf_resource_name }}_{{ node_group.name | sanitize_identifier }}" {
  name = "{{ resource_name }}-{{ node_group.name }}-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Action = "sts:AssumeRole"
      Effect = "Allow"
      Principal = {
        Service = "ec2.amazonaws.com"
      }
    }]
  })

  tags = {
{%- for key, value in tags.items() %}
    {{ key }} = "{{ value }}"
{%- endfor %}
    NodeGroup = "{{ node_group.name }}"
  }
}

resource "aws_iam_role_policy_attachment" "{{ tf_resource_name }}_{{ node_group.name | sanitize_identifier }}_worker" {
  policy_arn = "arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy"
  role       = aws_iam_role.{{ tf_resource_name }}_{{ node_group.name | sanitize_identifier }}.name
}

resource "aws_iam_role_policy_attachment" "{{ tf_resource_name }}_{{ node_group.name | sanitize_identifier }}_cni" {
  policy_arn = "arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy"
  role       = aws_iam_role.{{ tf_resource_name }}_{{ node_group.name | sanitize_identifier }}.name
}

resource "aws_iam_role_policy_attachment" "{{ tf_resource_name }}_{{ node_group.name | sanitize_identifier }}_registry" {
  policy_arn = "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"
  role       = aws_iam_role.{{ tf_resource_name }}_{{ node_group.name | sanitize_identifier }}.name
}

# EKS Node Group: {{ node_group.name }}
resource "aws_eks_node_group" "{{ tf_resource_name }}_{{ node_group.name | sanitize_identifier }}" {
  cluster_name    = aws_eks_cluster.{{ tf_resource_name }}.name
  node_group_name = "{{ node_group.name }}"
  node_role_arn   = aws_iam_role.{{ tf_resource_name }}_{{ node_group.name | sanitize_identifier }}.arn
  subnet_ids      = var.subnet_ids

  scaling_config {
    desired_size = {{ node_group.desired_size }}
    max_size     = {{ node_group.max_size }}
    min_size     = {{ node_group.min_size }}
  }

  instance_types = [
{%- for instance_type in node_group.instance_types %}
    "{{ instance_type }}"{{ "," if not loop.last else "" }}
{%- endfor %}
  ]

  tags = {
{%- for key, value in tags.items() %}
    {{ key }} = "{{ value }}"
{%- endfor %}
    NodeGroup = "{{ node_group.name }}"
  }

  depends_on = [
    aws_iam_role_policy_attachment.{{ tf_resource_name }}_{{ node_group.name | sanitize_identifier }}_worker,
    aws_iam_role_policy_attachment.{{ tf_resource_name }}_{{ node_group.name | sanitize_identifier }}_cni,
    aws_iam_role_policy_attachment.{{ tf_resource_name }}_{{ node_group.name | sanitize_identifier }}_registry,
  ]
}
{%- endfor %}
